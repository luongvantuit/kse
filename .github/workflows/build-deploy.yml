name: Deployment project to server

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [16.x]
    steps:
      - uses: actions/checkout@v3
        name: Build actions checkout
      - uses: actions/setup-node@v3
        name: Build Node.JS with version 16
        with:
          node-version: ${{matrix.node-version}}
      - run: yarn install --frozen-lockfile
        name: Yarn install package backend working directory
        working-directory: be
      - run: yarn install --frozen-lockfile
        name: Yarn install package frontend working directory
        working-directory: fe
      - run: CI=false && yarn build
        name: Yarn build project frontend
        working-directory: fe
  docker:
    needs: [build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        name: Build Docker actions checkout
      - run: docker version
        name: Docker version
      - run: docker-compose up --build -d be
        name: Run Docker Compose up build backend
      - run: docker-compose up --build -d fe
        name: Run Docker Compose up build frontend
  deploy:
    needs: [build, docker]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        name: Deployment action checkout
      - uses: appleboy/ssh-action@master
        name: Run deploy with SSH
        if: github.ref == 'refs/heads/master' && github.event_name == 'push'
        with:
          host: ${{secrets.SERVER_HOST}}
          username: ${{secrets.SERVER_USER}}
          password: ${{secrets.SERVER_PASSWORD}}
          port: ${{secrets.SERVER_PORT}}
          script: |
            echo "--- Update package ---"
            apt update 
            apt upgrade -y
            if [ -x "$(command -v docker)" ]; then
              echo "--- Update Docker ---"
              apt-get upgrade docker-engine -y
            else
              echo "--- Install Docker Engine"
              apt-get update -y
              apt-get install ca-certificates curl gnupg lsb-release -y
              mkdir -p /etc/apt/keyrings
              curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
              echo \
              "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
              $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
              apt-get update -y
              apt-get install docker-ce docker-ce-cli containerd.io docker-compose-plugin -y
            fi
            echo "--- Docker version ---"
            docker version
            echo "--- Check git version ---"
            if [ -x "$(command git)" ]; then
              apt install git -y
            fi
            if [ -d $HOME/projects/kse ]; then
              if [ -d $HOME/projects ]; then
                mkdir $HOME/projects
              fi
              cd $HOME/projects
              git clone https://${{secrets.GITHUB_USERNAME}}:${{secrets.GITHUB_TOKEN}}@github.com/luongvantuit/kse.git
            else 
              cd $HOME/projects/kse
              git pull origin master
            cd $HOME/projects/kse
            docker-compose up --build -d be
            docker-compose up --build -d fe
